<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>TV weather</title>
  <link rel="stylesheet" href="setup.css">
  <link rel="stylesheet" href="tenkiloop.css">
  <script src="jquery-3.5.1.min.js"></script>
  <script src="program.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Overpass:wght@700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@700&display=swap" rel="stylesheet">
</head>
<body>
  <div id="menuArea">
    <h1>設定</h1>
    <div id="menuAreaDisplay">
      <div class="fluentButton" id="chitenListCheck"><div class="fluentImgArea"><img class="fluentImg"src="./ic_fluent_location_24_filled.png"></div><p>地点</p></div>
      <div class="fluentButton" id="ichiListCheck"><div class="fluentImgArea"><img class="fluentImg"src="./ic_fluent_position_forward_24_filled.png"></div><p>表示位置</p></div>
    </div>
    
  </div>
  <div id="detailsArea">
    <div class="detailesAreaContents" id="chitenAreaContents">
      <div id="topArea">
        <h1>地点</h1>
        <p>表示したい地点を選択してください</p>
      </div>
      <div id="centerArea">
        <table class="areaList">
          <!-- ここに地名が表示されます -->
        </table>
      </div>
      <div id="bottomArea">
        <p id="checknum">選択済みの地点：0</p>
      </div>
      <input id="resetListCheck" type="button" value="リセット"/>
      <input id="setListCheck" type="button" value="決定"/>
    </div>
    <div class="detailesAreaContents" id="ichiAreaContents">
      <div id="topArea">
        <h1>表示位置</h1>
        <p>表示したい位置を設定してください</p>
      </div>
        <img src="./gamen.png" id="gamen_png">
        <div class='td_list'>
          <p>X軸</p>
          <input type="number" id="inputxnum" max="1920" min="1" value="380"style="text-align:right">
        </div>
        <div class='td_list'>
          <p>Y軸</p>
          <input type="number" id="inputynum" max="1920" min="1" value="30"style="text-align:right">
        </div>
        <div id="buttonarea">
          <input id="resetichiCheck" type="button" value="初期値"/>
          <input id="setichiCheck" type="button" value="決定"/>
          
        </div>
        
    </div>
  </div>
  
  
    
    <script>
      $(function(){
      var center_name_list = []
      var area_name_list = []
      var xnumdata = window.localStorage.getItem('tenkixnum');
      var ynumdata = window.localStorage.getItem('tenkiynum');
      var urls=[];
      var serializedArray1 = window.localStorage.getItem('urldatanum');

      

      if(xnumdata!=null){
        $("#inputxnum").val(xnumdata);
      $("#inputynum").val(ynumdata);
      }
      $("#ichiAreaContents").toggle();
    fetch('https://www.jma.go.jp/bosai/common/const/area.json')
      .then(response => response.json())
      .then(data => {
        const areaListElement = document.getElementById('areaList');
        
        for (const centerCode in data.centers) {
            const center = data.centers[centerCode];
            center_name_list.push(center.name);
            $('.areaList').append('<tr><th class="centername">'+center.name+'</th></tr>');
            //$('#areaList').append("<ul id='"+center.name+"list'></ul>");
            for (var i=0;i<center.children.length;i++) {
                code = center.children[i]
                url = "https://www.jma.go.jp/bosai/forecast/data/forecast/"+code+".json";
                
                try {
                  var jsonData = fetchJsonSync(url);
                  formatWeather(jsonData,center.name,code);
                } catch (error) {
                  console.error('データの取得に失敗しました。', error);
                }
            }
        }
      })
      .catch(error => console.error('データの取得に失敗しました。', error));
    
    function fetchJsonSync(url) {
      var request = new XMLHttpRequest();
      request.open('GET', url, false);  // 同期的に行うために false を指定
      request.send();

      if (request.status === 200) {
        return JSON.parse(request.responseText);
      } else {
        throw new Error(`Failed to fetch data: ${request.status}`);
      }
    }

    function formatWeather(weather,name,code){
      const areaListElement = document.getElementById('areaList');
      var area_len = weather[0].timeSeries[0].areas.length;
      //console.log(area_len);
      for (var i=0;i<area_len;i++){
        var area = weather[0].timeSeries[2].areas[i].area.name;
        var tmp = [name,area,code,i];
        console.log(tmp);
        var val = code + String(i);
        console.log(val);
        $(".areaList").append("<tr><td class='centername'><div class='td_list'><p>"+area+"</p><input type='checkbox' name='check4' class='checkbox' id="+val+" value="+val+" /></div></td></tr>");
      }
      
      if(serializedArray1!=null){
          var getValue = JSON.parse(serializedArray1);
          urls=[];
          urls=getValue;
          for(var i=0;i<urls.length;i++){
            $("#"+urls[i]).prop('checked', true);
          }
      }
      put_check_num()
    }
    
        jQuery(document).on('change', '[name="check4"]', function () {
        //console.log(i);
        put_check_num();
        
    });

    function put_check_num(){
      var i=0;
        var aryCmp = [];
        $('[name="check4"]:checked').each(function(index, element){
            i++;
        });
        $('#checknum').empty();
        $('#checknum').append("選択済みの地点："+i);
    }

    $('#resetListCheck').on('click', function() {
      $('[name="check4"]').removeAttr('checked').prop('checked', false).change();
    });

    var now_page=1;
    $("#ichiListCheck").hover(function(){
      if(now_page==1){
        $('#ichiListCheck').css('background-color', '#ededed');
      }
    }, function(){
      if(now_page==1){
        $('#ichiListCheck').css('background-color', '#f3f3f3');
      }
    });

    $("#chitenListCheck").hover(function(){
      if(now_page==0){
        $('#chitenListCheck').css('background-color', '#ededed');
      }
    }, function(){
      if(now_page==0){
        $('#chitenListCheck').css('background-color', '#f3f3f3');
      }
    });
    $('#chitenListCheck').on('click', function() {
      
      if(now_page==0){
        $('#chitenListCheck').css('background-color', '#ededed');
        $('#ichiListCheck').css('background-color', '#f3f3f3');
        $("#ichiAreaContents").toggle();
        $("#chitenAreaContents").toggle();
        
        now_page=1;
      }
    });
    
    $('#ichiListCheck').on('click', function() {
      
      if(now_page==1){
        $('#chitenListCheck').css('background-color', '#f3f3f3');
        $('#ichiListCheck').css('background-color', '#ededed');
        $("#ichiAreaContents").toggle();
        $("#chitenAreaContents").toggle();
        
        now_page=0;
      }
    });
    // $('#ichiListCheck').on('mouseenter', function() {
    //   $('#ichiListCheck').css('background-color', '#ededed');
    // });

    $('#setichiCheck').on('click', function() {
      if($("#inputxnum").val()>0&&$("#inputynum").val()>0){
        window.myAPI.send([2,$("#inputxnum").val(),$("#inputynum").val()]);
      }
      
      
    });
    $('#resetichiCheck').on('click', function() {
      $("#inputxnum").val(380);
      $("#inputynum").val(30);

    });
    
    

    $('#setListCheck').click(function(){
      var tmp=[]
      tmp.push("1");
        $('[name="check4"]:checked').each(function(index, element){
          tmp.push($(element).val());
           
        });
        if(tmp.length==0){
          alert("表示したい地点を選択してください。")
        }else{
          const serializedArray = JSON.stringify(tmp);
          window.localStorage.setItem('urldatanum', serializedArray);
          window.myAPI.send(tmp);
        }
        
    });
    });
    </script>
</body>
</html>